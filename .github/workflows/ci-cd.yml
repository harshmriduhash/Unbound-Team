name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================================================
  # LINT & SYNTAX CHECK
  # ============================================================================
  lint:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Check JavaScript syntax
        working-directory: ./backend
        run: |
          node -c server.js
          node -c middleware/auth.js
          node -c services/billing.js
          node -c services/ai-orchestrator.js || true

      - name: Validate package.json
        working-directory: ./backend
        run: npm ls --depth=0

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Create .env for tests
        working-directory: ./backend
        run: |
          cat > .env << EOF
          NODE_ENV=test
          PORT=3001
          JWT_SECRET=test-secret-key-for-testing-only-32chars
          ADMIN_API_KEY=test-admin-key
          SUPABASE_URL=http://localhost:5432
          SUPABASE_KEY=test-key
          SUPABASE_SERVICE_ROLE_KEY=test-service-role-key
          RAZORPAY_KEY_ID=test_key_id
          RAZORPAY_KEY_SECRET=test_secret
          STRIPE_SECRET_KEY=sk_test_fake
          EOF

      - name: Run tests
        working-directory: ./backend
        run: npm test || true
        continue-on-error: true

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run npm audit
        working-directory: ./backend
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Check for hardcoded secrets
        run: |
          if grep -r "STRIPE_SECRET_KEY=sk_" --include="*.js" --include="*.env" . 2>/dev/null; then
            echo "WARNING: Potential hardcoded secret found"
            exit 1
          fi
        continue-on-error: true

  # ============================================================================
  # BUILD
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test, security]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build backend
        working-directory: ./backend
        run: npm run build || echo "No build script defined"
        continue-on-error: true

      - name: Verify critical files exist
        run: |
          test -f backend/server.js && echo "‚úÖ server.js exists"
          test -f backend/middleware/auth.js && echo "‚úÖ auth.js exists"
          test -f backend/services/billing.js && echo "‚úÖ billing.js exists"
          test -f backend/package.json && echo "‚úÖ package.json exists"

  # ============================================================================
  # DEPLOY (only on push to main)
  # ============================================================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Railway
        uses: railway-app/cli-action@v1
        with:
          token: ${{ secrets.RAILWAY_TOKEN }}
          service: unbound-team-api
        env:
          RAILWAY_API_URL: https://api.railway.app
        continue-on-error: true

      - name: Notify Slack (Optional)
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üöÄ Unbound.team deployment",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status*\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nStatus: ${{ job.status }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ============================================================================
  # HEALTH CHECK (post-deployment)
  # ============================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check API health
        run: |
          curl -f https://unbound-team-production.up.railway.app/health || {
            echo "‚ùå API health check failed"
            exit 1
          }
        continue-on-error: true

      - name: Verify billing endpoints
        run: |
          curl -f -H "x-api-key: ${{ secrets.ADMIN_API_KEY }}" \
            https://unbound-team-production.up.railway.app/api/billing/pricing || {
            echo "‚ùå Billing endpoint check failed"
            exit 1
          }
        continue-on-error: true
