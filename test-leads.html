<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Lead Generation - Unbound.team</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="max-w-2xl w-full">
    <div class="bg-gray-800 rounded-lg p-8 border border-gray-700">
      <h1 class="text-3xl font-bold mb-2">Unbound.team Lead Generator</h1>
      <p class="text-gray-400 mb-8">Test the autonomous AI lead generation system</p>

      <form id="leadForm" class="space-y-6">

        <div>
          <label class="block text-sm font-medium mb-2">Target Industry/Client Type</label>
          <input
            type="text"
            id="industry"
            value="high-end business clients seeking business strategist"
            class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:border-blue-500 focus:outline-none"
            required
          >
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Number of Leads</label>
          <input
            type="number"
            id="count"
            value="10"
            min="1"
            max="50"
            class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:border-blue-500 focus:outline-none"
            required
          >
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Location</label>
          <input
            type="text"
            id="location"
            value="global"
            class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:border-blue-500 focus:outline-none"
          >
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Company Profile/Website</label>
          <input
            type="text"
            id="profile"
            value="maggieforbesstrategies.com - business strategist specializing in optimization and scaling"
            class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-2 focus:border-blue-500 focus:outline-none"
          >
        </div>

        <button
          type="submit"
          id="submitBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded transition"
        >
          Generate Leads
        </button>
      </form>

      <div id="loading" class="hidden mt-8 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-400">AI is searching for leads...</p>
      </div>

      <div id="results" class="hidden mt-8">
        <h2 class="text-2xl font-bold mb-4">Results</h2>
        <div id="summary" class="bg-gray-900 rounded p-4 mb-4"></div>
        <div id="leadsList" class="space-y-4"></div>
        <button
          onclick="downloadCSV()"
          class="mt-6 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded"
        >
          Download CSV
        </button>
      </div>

      <div id="error" class="hidden mt-8 bg-red-900/20 border border-red-500 rounded p-4"></div>
    </div>
  </div>

  <script>
    let currentResults = null;
    let pollInterval = null;

    document.getElementById('leadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const error = document.getElementById('error');

      // Hide previous results
      results.classList.add('hidden');
      error.classList.add('hidden');

      // Show loading
      loading.classList.remove('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating...';

      try {
        // Call Railway backend lead generation endpoint
        const response = await fetch('/api/solutions/lead-generation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: 'test-user',
            targetIndustry: document.getElementById('industry').value,
            location: document.getElementById('location').value,
            criteria: {
              count: parseInt(document.getElementById('count').value),
              minScore: 8,
              industry: 'business strategy and scaling',
              companySize: 'established businesses ready to scale',
              painPoints: ['business optimization', 'scaling challenges', 'strategic growth'],
              budget: 'high-end',
              clientProfile: document.getElementById('profile').value
            }
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to generate leads');
        }

        // Check if this is a queue-based response (has jobId) or direct response (has leads)
        if (data.jobId) {
          // Queue-based: poll for results
          loading.querySelector('p').textContent = 'Job queued. Checking status...';
          await pollJobStatus(data.jobId, data.statusUrl);
        } else if (data.leads) {
          // Direct response: display immediately
          currentResults = data;
          displayResults(data);
          loading.classList.add('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Generate Leads';
        } else {
          throw new Error('Unexpected response format');
        }

      } catch (err) {
        console.error('Error:', err);
        error.textContent = err.message;
        error.classList.remove('hidden');
        loading.classList.add('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Leads';
      }
    });

    async function pollJobStatus(jobId, statusUrl) {
      const maxAttempts = 60; // 5 minutes max (5 second intervals)
      let attempts = 0;

      while (attempts < maxAttempts) {
        try {
          const response = await fetch(statusUrl);
          const jobStatus = await response.json();

          if (jobStatus.state === 'completed' && jobStatus.result) {
            // Job completed successfully
            currentResults = jobStatus.result;
            displayResults(jobStatus.result);
            loading.classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = 'Generate Leads';
            return;
          } else if (jobStatus.state === 'failed') {
            throw new Error(jobStatus.error || 'Job failed');
          }

          // Update status message
          loading.querySelector('p').textContent = `Processing... (${Math.round(jobStatus.progress || 0)}%)`;

          // Wait 5 seconds before next poll
          await new Promise(resolve => setTimeout(resolve, 5000));
          attempts++;
        } catch (err) {
          throw new Error(`Failed to check job status: ${err.message}`);
        }
      }

      throw new Error('Job timed out after 5 minutes');
    }

    function displayResults(data) {
      const summary = document.getElementById('summary');
      const leadsList = document.getElementById('leadsList');
      const results = document.getElementById('results');

      // Extract data with fallbacks
      const leadsFound = data.leadsFound || data.leads?.length || 0;
      const leads = data.leads || [];
      const avgFitScore = data.summary?.avgFitScore || (leads.reduce((sum, l) => sum + (l.fitScore || 0), 0) / (leads.length || 1));
      const sources = data.summary?.sources || [...new Set(leads.map(l => l.source))];

      // Summary
      summary.innerHTML = `
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-3xl font-bold text-blue-500">${leadsFound}</p>
            <p class="text-sm text-gray-400">Leads Found</p>
          </div>
          <div>
            <p class="text-3xl font-bold text-green-500">${avgFitScore.toFixed(1)}/10</p>
            <p class="text-sm text-gray-400">Avg Fit Score</p>
          </div>
          <div>
            <p class="text-3xl font-bold text-purple-500">${sources.length}</p>
            <p class="text-sm text-gray-400">Sources</p>
          </div>
        </div>
      `;

      // Leads list
      leadsList.innerHTML = leads.map((lead, i) => `
        <div class="bg-gray-900 rounded p-4 border border-gray-700">
          <div class="flex justify-between items-start mb-2">
            <div>
              <h3 class="font-bold text-lg">${i + 1}. ${lead.name}</h3>
              ${lead.company ? `<p class="text-gray-400 text-sm">${lead.company}</p>` : ''}
            </div>
            <span class="px-3 py-1 bg-blue-900 text-blue-300 rounded text-sm">
              ${lead.fitScore || 'N/A'}/10
            </span>
          </div>
          <p class="text-sm text-gray-400 mb-2">Source: ${lead.source}</p>
          ${lead.description ? `<p class="text-sm mb-2">${lead.description}</p>` : ''}
          ${lead.painPoints ? `<p class="text-sm text-gray-400">Pain Points: ${lead.painPoints}</p>` : ''}
          ${lead.outreachTip ? `<p class="text-sm text-green-400 mt-2">ðŸ’¡ ${lead.outreachTip}</p>` : ''}
          <a href="${lead.url}" target="_blank" class="text-blue-400 text-sm hover:underline mt-2 inline-block">
            View Profile â†’
          </a>
        </div>
      `).join('');

      results.classList.remove('hidden');
    }

    function downloadCSV() {
      if (!currentResults || !currentResults.csv) return;

      const blob = new Blob([currentResults.csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'leads.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>
